@page "/datachecker"

@using MeetNSeat.Client.Services
@using System.Security.Claims
@using MeetNSeat.Client.Models
@using Blazored.SessionStorage

@attribute [Authorize]
@inject IApiClientService ApiClientService;
@inject ISessionStorageService Storage
@inject AuthenticationStateProvider AuthenticationStateProvider

<div>
    <h3>User Ip - @ipAddress.Ip</h3>
    <h3>User Id - @userId</h3>
    <h3>ClaimsPrincipal Data</h3>

    <p>@authMessage</p>

    @if (claims.Count() > 0)
    {
        <table class="table">
            @foreach (var claim in claims)
            {
                <tr>
                    <td>@claim.Type</td>
                    <td>@claim.Value</td>
                </tr>
            }
        </table>
    }
</div>

@code {
    private string userId;
    private string authMessage;
    IpAddress ipAddress = new IpAddress();
    private IEnumerable<Claim> claims = Enumerable.Empty<Claim>();

    protected override async Task OnInitializedAsync()
    {
        ipAddress = await ApiClientService.GetUserIPAsync();
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            authMessage = $"{user.Identity.Name} is authenticated.";
            claims = user.Claims;
        }
        else
        {
            authMessage = "The user is NOT authenticated.";
        }

        var storedUserId = await Storage.GetItemAsync<string>("userId");
        userId = storedUserId.Split(" ")[2];
    }
}